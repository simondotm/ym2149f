<!DOCTYPE html>
<html lang="en">

<head>
    <title>YM2149</title>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" />    
    <link rel="stylesheet" href="{{ site.baseurl }}/css/bulma.css" type="text/css">

    <style>
      body {
          padding-top: 50px;
      }
    </style>
    <script type="text/javascript" src="{{ site.baseurl }}/js/jquery1.11.min.js"></script>
    <script type="text/javascript" src="{{ site.baseurl }}/js/jquery.details.min.js"></script>
    <script type="text/javascript" src="{{ site.baseurl }}/js/scriptprocessor_player.min.js"></script>
    
    <script>window.openDetails=false;</script>
    <script type="text/javascript" src="{{ site.baseurl }}/js/mini_display.js"></script>
    <script type="text/javascript" src="{{ site.baseurl }}/js/mini_controls.js"></script>

    <script type="text/javascript" src="{{ site.baseurl }}/js/backend_vgm.js"></script>    

    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase.js"></script>
    <!-- Firebase App is always required and must be first -->
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-app.js"></script>    
    <!-- Add additional services that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-functions.js"></script>
    <script>
      // Initialize Firebase
      // TODO: Replace with your project's customized code snippet
      var config = {
        apiKey: "AIzaSyAM69N-rFgZcJOeT-91GUugmcovL3tLpVc",
        authDomain: "ym2149-39dcc.firebaseapp.com",
        databaseURL: "https://ym2149-39dcc.firebaseio.com",
        projectId: "ym2149-39dcc",
        storageBucket: "ym2149-39dcc.appspot.com",
        messagingSenderId: "694120657177"
      };
      firebase.initializeApp(config);

      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          // User is signed in.
          var isAnonymous = user.isAnonymous;
          var uid = user.uid;

          dbInitCounts();

          // ...
          //alert("user signed in, isAnonymous=" + isAnonymous + " uid=" + uid);
        } else {
          // User is signed out.
          // ...
          //alert("user signed out");
          myLogin();
        }
        // ...
      });      
    </script>

    <script>
        var playerControls;
        var	songDisplay;
        
        var songs = [
            // add your music files here, e.g.:
            {% for vgm in site.data.content.content %}
              '{{ vgm.url }}',            
            {% endfor %}
        ];
        
        // configure what music infos to display in SongDisplay
        VGMDisplayAccessor = (function(){ var $this = function (doGetSongInfo) {
                $this.base.call(this, doGetSongInfo);
            }; 
            extend(DisplayAccessor, $this, {
                getDisplayTitle: function() 	{ return this.getSongInfo().title;},
                getDisplaySubtitle: function() 	{ return this.getSongInfo().author;},
                getDisplayLine1: function() { return this.getSongInfo().comment;},
                getDisplayLine2: function() { return this.getSongInfo().program; },
                getDisplayLine3: function() { return ""; }
            });	return $this; })();
                
        // link player events to "controls" and "display"
        function doOnTrackEnd(){
            if (playerControls) playerControls.playNextSong();  
        }
        function doOnTrackReadyToPlay(){ 	
            ScriptNodePlayer.getInstance().play();
            songDisplay.redrawSongInfo();
        }
        function doOnPlayerReady() {
            if (playerControls) playerControls.playNextSong();
        }
        function init() {
            // --------------------------- VGM music player -----------------------
            var basePath= '';		// not needed here
            ScriptNodePlayer.createInstance(new VgmBackendAdapter(), basePath, ["VGMPlay.ini", "yrw801.rom"], true,
                                                doOnPlayerReady, doOnTrackReadyToPlay, doOnTrackEnd);
                
            playerControls= new BasicPlayerControls(songs, true, false,
                        (function(someSong) {
                            var arr= someSong.split(";");	
                            var boostVolume= arr.length>1?parseInt(arr[1]):0;		
                            var url= arr[0];
                            
                            var options= {};
                            options.track= 0;// archives are not supported and *.vgz/*.vgm contain always 1 track
                            options.boostVolume= boostVolume;
                            return [url, options];
                        }),
                        0
                    );
        
            var yellow= 0xf4cb25;
            var red= 0xef210a;
            var blue= 0x1b1088;
            var purple= 0x630f64;
            
            songDisplay= new SongDisplay(new VGMDisplayAccessor((function(){return playerControls.getSongInfo();})), 
                                        [yellow, red, purple, blue, blue], 1, 0.1, (function(){playerControls.animate()}));
        
            playerControls.playNextSong();

            if (firebase.auth().currentUser === null) {
              myLogin();
            }



        }

        var selectedSong = null;
        // where songName is the content URL (not the site URL)
        function myPlaySong(songName)
        {
          if (selectedSong != null)
          {
            var item = document.getElementById(selectedSong);
      		  item.removeAttribute("class", "is-selected");	            
          }

          var item = document.getElementById(songName);
          item.setAttribute("class", "is-selected");	
          selectedSong = songName;	   
          

          dbAddPlay(songName);

          playerControls.playSong('{{ site.baseurl }}/' + songName);
        }

        // Firebase keys cannot contain ., $, #, [, ], /
        function dbSongId(songName)
        {
          //return songName.replace(/\W+/g, "_");
          var db_id = songName;
          db_id = db_id.replace(/\./g, "%2E");
          db_id = db_id.replace(/\$/g, "%23");
	      	db_id = db_id.replace(/\#/g, "%24");
      		db_id = db_id.replace(/\[/g, "%5B");
          db_id = db_id.replace(/\]/g, "%5D");
          return db_id;
        }


        function dbAddPlay(songName)
        {          
          var database = firebase.database();
          const counterRef = database.ref(dbSongId(songName) + "/playCount").transaction(current => { return (current || 0) + 1; });
        }

        function dbUpdatePlayCount()
        {

        }

        function dbGetPlays(songName)
        {
          var dbId = dbSongId(songName)
          var countRef = firebase.database().ref(dbId + "/playCount");
          countRef.on('value', function(snapshot) {
            dbUpdatePlayCount(songName, snapshot.val());
          });
        }

        // assumes user is logged in
        function dbInitCounts()
        {
          for (var i = 0; i < songs.length; i++) {
            var songName = songs[i];

            var dbId = dbSongId(songName)

            // playcounts
            var dbRef = firebase.database().ref(dbId + "/playCount");
            //dbRef.on('value', snap => playCount.innerText = snap.val());
            dbRef.on('value', function(snapshot) {

              // Now simply find the parent and return the name.
              //var parname = snapshot.ref.parent.key;
              var ref = snapshot.ref.path.toString();

              var playCount = document.getElementById(ref);
              if ((playCount != null) && (snapshot.val() != undefined))
                playCount.innerHTML = snapshot.val();              
            });            

            // likes
            var dbRef = firebase.database().ref(dbId + "/likeCount");
            //dbRef.on('value', snap => playCount.innerText = snap.val());
            dbRef.on('value', function(snapshot) {

              // Now simply find the parent and return the name.
              //var parname = snapshot.ref.parent.key;
              var ref = snapshot.ref.path.toString();
              var count = document.getElementById(ref);//+"/likeCount");
              if (count != null)
              {
                if (snapshot.val() == undefined) {
                  //count.innerHTML = '';    
                }else{
                  count.innerHTML = snapshot.val();    
                }
              }
          
            });               

            // user likes - we're watching these for changes
            var dbRef = firebase.database().ref("/users/" + firebase.auth().currentUser.uid + "/likes/content/vgm");
            dbRef.on('value', function(snapshot) {

              var v = snapshot.val(); 

              for (var p in v) {
                  if (v.hasOwnProperty(p)) {

                    var ref = "/content/vgm/" + p + "/likeStatus";
                    var e = document.getElementById(ref);
                    if (e != null)
                    {
                      if (v[p]) {
                        e.classList.add('is-danger');
                        e.classList.remove('is-dark');
                        e.classList.remove('is-outlined');
                      }else{
                        e.classList.remove('is-danger');
                        e.classList.add('is-dark');
                        e.classList.add('is-outlined');
                      }
                    }                    

                  }
              }              
          
            });               


            //Do something
          }

        }

/*
        function dbLike(songName)
        {
          if (firebase.auth().currentUser !== null) {
            db_id = dbSongId(songName);
            var database = firebase.database();
            database.ref(db_id + "/likeCount").transaction(current => { return (current || 0) + 1; });
            var uid = firebase.auth().currentUser.uid;
            var o = '{ "' + db_id + '": true }';
            database.ref("/users/" + uid + "/likes").update(JSON.parse(o));

          }
        }
      */

        function dbLike(songName)
        {
          if (firebase.auth().currentUser !== null) {
            db_id = dbSongId(songName);
            var dbRef = firebase.database().ref(db_id);
            dbRef.transaction(function(ref) {
              if (ref != null) {
                var uid = firebase.auth().currentUser.uid;
                if (!ref.hasOwnProperty("likes") || !ref.hasOwnProperty("likeCount")) {
                  ref.likes = [];
                  ref.likeCount = 0;
                }
                  
                if (ref.likes[uid]) {
                  ref.likeCount--;
                  ref.likes[uid] = false;
                }else {
                  ref.likeCount++;
                  ref.likes[uid] = true;
                }


//                ref.likes[uid] = true;

  //              var o = '{ "' + db_id + '": true }';
  //              database.ref("/users/" + uid + "/likes").update(JSON.parse(o));
  //              current => { return (current || 0) + 1; 
                return ref;
              }else{
                return {};
              }

            });


          }
        }


        function myLogin()
        {
          firebase.auth().signInAnonymously().catch(function(error) {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
            //alert(errorMessage);
            // ...
          });          
        }
        </script>    
</head>

<body onload="init();">
    <nav class="navbar is-fixed-top is-danger" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
          <a class="navbar-item" href="{{ site.baseurl }}/">
            <img src="{{ site.baseurl }}/img/ym2149.png" width="112" height="28">
          </a>



                      <div id="spectrum" >
                        <div id="moz-reflect-spectrum"><canvas id="spectrumCanvas" width="800" height="40"></canvas></div>
                      </div>   
                      <div class="navbar-item">       

                      </div>

          <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
          </a>
        </div>
      <!--
        <div id="navbarBasicExample" class="navbar-menu">
          <div class="navbar-start">
            <a class="navbar-item">
              Home
            </a>
      
            <a class="navbar-item">
              Documentation
            </a>
      
            <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link">
                More
              </a>
      
              <div class="navbar-dropdown">
                <a class="navbar-item">
                  About
                </a>
                <a class="navbar-item">
                  Jobs
                </a>
                <a class="navbar-item">
                  Contact
                </a>
                <hr class="navbar-divider">
                <a class="navbar-item">
                  Report an issue
                </a>
              </div>
            </div>
          </div>
        -->
          <div class="navbar-end">





            
            <div class="navbar-item">
              <div class="buttons">
                <a class="button is-primary">
                  <strong>Sign up</strong>
                </a>
                <a class="button is-light" onclick="myLogin()">
                  Log in
                </a>
              </div>
            </div>
        
          </div>

        </div>
      </nav>


      <section class="section">

          <div class="container">

            <div class="columns">
              <div class="column is-full">
                <div class="card">
                  <div class="card-content">
                    <nav class="breadcrumb" aria-label="breadcrumbs">
                      <ul>
                        <li><a href="#">Home</a></li>
                        <li><a href="#">VGM</a></li>
                        <li class="is-active"><a href="#" aria-current="page">Demo Tunes</a></li>
                      </ul>
                    </nav>
                  </div>
                </div>
              </div>
              <!-- columns -->
            </div>
        
            <div class="columns">
              <div class="column is-full">
                <div class="card">
                  <div class="card-content">

                    <div class="media-content">
                      <div class="columns">

                        <div class="column">

                    <p id="vgmTitle" class="title is-4"></p>
                    <p id="vgmArtist" class="subtitle is-6"></p>
                    </div>

                    <div class="column">
                      <span id="controls"></span>
                      </div>



                      </div>
                  </div>

                  </div>
                </div>
              </div>
              <!-- columns -->
            </div>
            
            <div class="columns">
              <div class="column is-full">


                  <div class="card">

                  <table class="table is-striped is-hoverable is-fullwidth">
                    <thead>
                      <tr>
                        <th>Control</th>
                        <th>Length</th>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Likes</th>
                        <th>Tags</th>
                        <th>File</th>
                        <th>Plays</th>
                      </tr>
                    </thead>
                    <tbody>


                      {% for vgm in site.data.content.content %}
                        <tr id="{{ vgm.url }}">
                          <td>  <button class="button is-info is-rounded " onclick="myPlaySong('{{ vgm.url }}')"><strong class="fa fa-play"></strong></a></button>    </td>  
                          <td>{{ vgm.length }}</td>
                          <td>{{ vgm.title }}</td>
                          <td>{{ vgm.artist }}</td>

                          <td>
                              <a id="{{ vgm.db_id }}/likeStatus" class="button is-outlined is-dark is-rounded is-small" onclick="dbLike('{{ vgm.url }}')">
                                  <span class="icon is-small">
                                    <i class="fa fa-heart"></i>
                                  </span>
                                  <span><strong><div id="{{ vgm.db_id }}/likeCount"></div></strong></span>
                                </a>                         
                          </td>
                          <td>
                    <div class="tags are-normal">
                      <span class="tag is-rounded is-dark">{{ vgm.chip }}</span>
                      <span class="tag is-rounded is-dark">{{ vgm.clock }}</span>
                      <span class="tag is-rounded is-dark">{{ vgm.rate }}</span>
                    </div></td>
                        <td>
                        
                          <p class="control">
                            <a class="button is-info" href="{{ site.baseurl }}{{ vgm.url }}">
                              <strong class="fa fa-download"></strong>
                            </a>
                          </p>
                        </td>
                        <td><div id="{{ vgm.db_id }}/playCount"></div></td>
                      </tr>

                    {% endfor %}    
                    </tbody>
                  </table>


                  </div>

                  <!-- container -->
              </div> 
              <!-- columns -->
            </div>

            <div class="columns">            
              <div class="column is-full">
                <div class="card">
                  <div class="card-content">



                    <div class="card-content">
                      <div id="drop" class="drop"><img src="{{ site.baseurl }}/img/chip.png" width=270 height=270/><p>Or drop VGMs onto the Chip to listen!</p></div><!--see BasicPlayerControls-->            
                    </div>

                    <div id="logo">
                        <!-- in new Chrome the SHIT reflections disapear dependig on the canvas height.. what a fucking joke -->
                        <div id="moz-reflect-logo"><canvas  id="logoCanvas"  width="220" height="100"></canvas></div>	
                    </div>

                  </div>
                </div>
              </div>              

          <!-- columns -->
            </div>


          <!-- container -->
          </div>


      </section>

      <footer class="footer">
  <div class="content has-text-centered">
    <p>
      <strong>YM2149 Music Converted to SN76489</strong> by <a href="https://github.com/simondotm">Simon Morris</a>. The <a href="https://github.com/simondotm/ym2149f">source code</a> is licensed
      <a href="http://opensource.org/licenses/mit-license.php">MIT</a>. 
      Credits to Juergen Wothke for the fantastic <a href="https://github.com/wothke/vgmplay-0.40.6">Web VGM Player</a>
    </p>
    <p>
      <a class="button" href="https://twitter.com/simondotm">
        <span class="icon is-small">
          <i class="fa fa-twitter"></i>
        </span>
      </a>
      <a class="button" href="https://www.facebook.com/bitshiftrs/">
        <span class="icon is-small">
          <i class="fa fa-facebook"></i>
        </span>
      </a>
      <a class="button" href="https://github.com/simondotm/ym2149f">
        <span class="icon is-small">
          <i class="fa fa-github"></i>
        </span>
      </a>      
    </p>
  </div>
</footer>      
</body>
</html>